---
title: "NFL Losers Pool 2021"
author: "Jordan Hutchings"
date: "08/09/2021"
output: 
  html_document:
    keep_md: true
---


```{r, echo = FALSE}
knitr::opts_chunk$set(
  fig.path = "README_figs/README-"
)
```

## Download data from [FiveThirtyEight](https://projects.fivethirtyeight.com/2021-nfl-predictions/games/)
I construct the week numbers, and collect the forecasted losing team, as well as 
their losing probability. 


```{r}
pacman::p_load(data.table, tidyverse, knitr, kableExtra, ggalt)

path <- "https://projects.fivethirtyeight.com/nfl-api/nfl_elo_latest.csv"
week1 <- as.Date("2021-09-09")

df <- fread(path)

# clean data: calculate week, get proj loser and prob of loss. 
df <- df %>%
  mutate(loser = ifelse(qbelo_prob1 > qbelo_prob2, team2, team1),
         week = floor(as.numeric(difftime(date, week1, units="days")) / 7) + 1,
         p_lose = ifelse(qbelo_prob1 > qbelo_prob2, qbelo_prob2, qbelo_prob1)) %>%
  select(week, loser, p_lose)


```

## Visualize the possible picks per week
```{r}
ggplot(df, aes(week, loser, fill=p_lose)) + 
    geom_tile() + scale_fill_viridis_c("Pr(Win)") + 
  theme_bw() + labs(title = "Probability of winning for underdog, week X team")
```

The Texans and Lions are the most likely to lose in most weeks. We can see that 
the Texans stand out as an obvious pick in Week 2, however are more likely to lose 
in week 4.

## Identifying the optimal time to pick each team
We want to identify the optimal pick per week given the set of probabilities 
each team has of losing their weekly game subject to the constraint of only 
being able to pick each team once. 

Possible approaches: 

1.  Pick the lowest probability of winning each week
2.  Pick the lowest probability of winning each team
3.  Pick the team ina given week with the largest change if they're 
not selected.
4.  [TBD] Pick the combination of games that lead to the lowest sum of win 
probabilities across all the weeks. 

Lets compare the outcomes below, with our outcome of choice being the 
sum of the probability of winning. 

## Approach 1: 
Once a team is picked in a given week, we remove the team. We iterate through 
picking the team with the lowest probability.

```{r}
total_weeks <- 13
picks <- list()
teams <- c()

for(w in 1:total_weeks){
  
    if(w>1){
      tmp <- subset(df, !(loser%in%teams))
    } else{tmp <- df}
  
    pick <- tmp %>% filter(week == w) %>%
      arrange(p_lose) %>%
      slice(1L)
  teams <- append(teams, pick$loser)
  picks[[w]] <- pick
  
}

picks <- do.call(rbind.data.frame, picks)
names(picks) <- c("Week", "Team", "Pr(Win)")

kable(picks, digits = 2) %>%
  kable_classic(full_width = F)
```

## Approach 2: 
Pick the lowest probability for each team. 
We can iterate through picking the lowest absolute probability, then add that 
team and week and remove from the list of contenders. 

Last year the winner was determined in Week 13. We can therefore only pick the 
lowest probabilities from the first 13 weeks. This has a slight improvement 
from if we include all 18 weeks, however most of the changes are seen in later 
weeks (week 9).

```{r}
weeks2 <- c()
teams2 <- c()
picks2 <- list()
w <- 1


while(w <= total_weeks){
  tmp <- df
  tmp <- subset(tmp, !(loser%in%teams2))
  tmp <- subset(tmp, !(week%in%weeks2))
  tmp <- subset(tmp, week <= total_weeks)
  
  pick <- tmp %>%
    arrange(p_lose) %>%
    slice(1L)
  weeks2 <- append(weeks2, pick$week)
  teams2 <- append(teams2, pick$loser)
  picks2[[w]] <- pick
  
  w = w+1
}

picks2 <- do.call(rbind.data.frame, picks2)
picks2 <- arrange(picks2, week)
names(picks2) <- c("Week", "Team", "Pr(Win)")

kable(picks2, digits = 2) %>%
  kable_classic(full_width = F)
```

## Approach 3: 
We can apply a different algorithm to identify the best solution. 
In words, we look to find the greatest difference between the best 
weekly pick, and the next best weekly pick. Then we pick the team 
with the largest difference, i.e. the most valuable team.
This approach is largely based on picking the teams with the largest 
opportunity cost. 

It is worth considering if this is optimal, there maybe a situation where 
the opportunity cost in one week is worth the gains across multiple weeks. 

Pseudocode:

1. Sort by lowest win probability by week
2. Calculate the difference for each week between the probabilities of the 
most likely team to lose, and the next likely. 
3. Rank the differences for the most and second most likely teams. 
4. Take the team with the largest difference. 
5. Remove this team and week from the pool. 
6. Go to the next largest difference and repeat. 

```{r}
most_constrained <- function(df, teams, weeks){
  tmp <- df %>% 
    filter(!loser %in% teams) %>%
    filter(!week %in% weeks) %>%
    group_by(week) %>%
    arrange(week, p_lose) %>% 
    mutate(diff = lead(p_lose, 1) - p_lose) %>%
    slice(1L) %>%
    ungroup() %>%
    mutate(rank = rank(-diff)) %>%
    filter(rank == 1) %>%
    select(week, loser, p_lose)
  
  return(tmp)
}

teams <- c()
weeks <- c(seq(total_weeks + 1, 18, 1)) # add weeks we want to overlook. 
picks3 <- list()

i <- 1
while(i <= total_weeks){
  pick <- most_constrained(df, teams, weeks)
  teams <- append(teams, pick$loser)
  weeks <- append(weeks, pick$week)
  picks3[[i]] <- pick

  i = i + 1 
}

picks3 <- do.call(rbind.data.frame, picks3)
picks3 <- arrange(picks3, week)

labs <- c("Week", "Team", "ProbWin")
names(picks3) <- labs
```


## Visualize differences across models

### Dumbbell plot of Approaches 1 and 2
```{r}
labs <- c("Week", "Team", "ProbWin")
names(picks) <- labs
names(picks2) <- labs
names(picks3) <- labs

picks$Approach <- 1
picks2$Approach <- 2
picks3$Approach <- 3

data <- rbind(picks, picks2, picks3)
data$Approach <- as.factor(data$Approach)


theme_set(theme_bw(12))

ggplot(data, aes(x=Week, y=ProbWin, color = Approach, shape = Approach)) + 
  geom_line(aes(group = Week), color="#e3e2e1", size = 2) +
  geom_point(size = 3) + 
  coord_flip() + 
  scale_color_viridis_d() + 
  labs(title = "Comparing weekly win probabilities per Approach", 
       x = "Week Number", 
       y = "Probability of Win")
```


### Table of by week picks
We can see that Approach 2 has a lower probability on average, with a drastically 
lower probability of winning in week 4. 

```{r}

tbl <- left_join(picks, picks2, by="Week", suffix=c("_1", "_2"))
tbl <- left_join(tbl, picks3, by="Week", suffix=c("", "_3"))
tbl <- select(tbl, -c("Approach_1", "Approach_2", "Approach"))
names <- c("Week", rep(c("Team", "ProbWin"),3))
names(tbl) <- names

avg_1 <- mean(as.numeric(picks$ProbWin))
avg_2 <- mean(as.numeric(picks2$ProbWin))
avg_3 <- mean(as.numeric(picks3$ProbWin))
avg_row <- data.frame("Avg. Prob", "", avg_1, "", avg_2, "", avg_3)
names(avg_row) <- names(tbl)

tbl <- rbind(tbl, avg_row)

kbl(tbl, digits=3) %>%
  kable_classic(full_width=F) %>%
  add_header_above(c(" " = 1, "Approach 1" = 2, "Approach 2" = 2, "Approach 3" = 2)) %>%
  row_spec(total_weeks+1, bold=T)
```


# In developent.. 
Need to come up with the way of solving the below equation.

## Approach 4: 
This is a linear optimization problem. Normally I could solve this quickly in 
Excel using the built in solver. 

Our optimization problem is the following 
$$ \min_{x_{it}} \sum_i\sum_t p_{it}x_{it} \text{ s.t.} $$
$$\text{Team constraint: } \sum_i x_i \leq 1 \\ \text{Week constraint: }x_t = 1 \forall t $$

